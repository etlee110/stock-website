name: Crypto Watchtower Pipeline

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['.github/agents/**', '.github/workflows/crypto-watchtower.yml']

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
      
      - name: Configure Git
        run: |
          git config user.name "crypto-watchtower-bot"
          git config user.email "bot@crypto-watchtower.local"
      
      - name: Create directories
        run: mkdir -p data logs docs/data
      
      - name: Data Fetcher
        run: |
          echo "Fetching crypto data..."
          [ -f data/crypto-data.json ] && cp data/crypto-data.json data/crypto-data-previous.json
          curl -sS "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&sparkline=false&price_change_percentage=1h,24h" \
            -H "User-Agent: CryptoWatchtower/1.0" -o data/crypto-data-raw.json --max-time 10 --retry 3
          jq '{timestamp:(now|todate),data:[.[]|{id,symbol,name,current_price,price_change_percentage_1h,price_change_percentage_24h,total_volume,market_cap,last_updated}]}' \
            data/crypto-data-raw.json > data/crypto-data.json
          echo "Fetched $(jq '.data|length' data/crypto-data.json) coins"
      
      - name: Market Analyst
        run: |
          echo "Analyzing whale movements..."
          if [ ! -f data/crypto-data-previous.json ]; then
            echo '{"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","alerts":[],"total_alerts":0}' > data/whale-alerts.json
            echo "First run - no comparison"
            exit 0
          fi
          python3 << 'PYEOF'
          import json
          from datetime import datetime
          with open('data/crypto-data.json') as f: current = json.load(f)
          with open('data/crypto-data-previous.json') as f: previous = json.load(f)
          prev_prices = {c['id']: c['current_price'] for c in previous['data']}
          alerts = []
          for coin in current['data']:
              if coin['id'] not in prev_prices or prev_prices[coin['id']] == 0: continue
              change = ((coin['current_price'] - prev_prices[coin['id']]) / prev_prices[coin['id']]) * 100
              if abs(change) > 5:
                  severity = 'critical' if abs(change) > 20 else 'high' if abs(change) > 10 else 'medium'
                  emoji = 'ðŸ”´' if severity == 'critical' else 'ðŸŸ ' if severity == 'high' else 'ðŸŸ¡'
                  alerts.append({
                      'crypto_id': coin['id'], 'symbol': coin['symbol'].upper(), 'name': coin['name'],
                      'price_change_percent': round(change, 2), 'previous_price': prev_prices[coin['id']],
                      'current_price': coin['current_price'], 'severity': severity, 'emoji': emoji,
                      'time_interval': '15min',
                      'alert_message': f"{coin['name']} {'surged' if change > 0 else 'dropped'} {abs(round(change,2))}% in 15 minutes"
                  })
          alerts.sort(key=lambda x: ({'critical':0,'high':1,'medium':2}[x['severity']], -abs(x['price_change_percent'])))
          with open('data/whale-alerts.json', 'w') as f:
              json.dump({'timestamp': datetime.utcnow().isoformat()+'Z', 'alerts': alerts, 'total_alerts': len(alerts)}, f, indent=2)
          print(f"Detected {len(alerts)} whale movements")
          PYEOF
      
      - name: Report Generator
        run: |
          echo "Generating dashboard..."
          cp data/crypto-data.json docs/data/
          cp data/whale-alerts.json docs/data/
          python3 .github/scripts/generate-dashboard.py
      
      - name: Deploy
        run: |
          echo "Deploying..."
          git diff --quiet docs/ && echo "No changes" && exit 0
          git add docs/
          git commit -m "Update dashboard - $(date -u +%Y-%m-%dT%H:%M:%SZ)" -m "$(jq '.data|length' data/crypto-data.json) coins | $(jq '.total_alerts' data/whale-alerts.json) alerts"
          git push origin main
          echo "Deployed successfully"
      
      - name: Verify
        run: |
          sleep 30
          curl -sf https://etlee110.github.io/stock-website > /dev/null && echo "âœ“ Live" || echo "âš  Building..."
