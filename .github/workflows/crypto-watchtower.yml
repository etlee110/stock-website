name: Crypto Watchtower Pipeline

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths: ['.github/agents/**', '.github/workflows/crypto-watchtower.yml']

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
      
      - name: Configure Git
        run: |
          git config user.name "crypto-watchtower-bot"
          git config user.email "bot@crypto-watchtower.local"
      
      - name: Create directories
        run: mkdir -p data logs docs/data
      
      - name: Data Fetcher
        run: |
          echo "Fetching crypto data..."
          [ -f data/crypto-data.json ] && cp data/crypto-data.json data/crypto-data-previous.json
          curl -sS "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1&sparkline=false&price_change_percentage=1h,24h" \
            -H "User-Agent: CryptoWatchtower/1.0" -o data/crypto-data-raw.json --max-time 10 --retry 3
          jq '{timestamp:(now|todate),data:[.[]|{id,symbol,name,current_price,price_change_percentage_1h,price_change_percentage_24h,total_volume,market_cap,last_updated}]}' \
            data/crypto-data-raw.json > data/crypto-data.json
          echo "Fetched $(jq '.data|length' data/crypto-data.json) coins"
      
      - name: Market Analyst
        run: |
          echo "Analyzing whale movements..."
          if [ ! -f data/crypto-data-previous.json ]; then
            echo '{"timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","alerts":[],"total_alerts":0}' > data/whale-alerts.json
            echo "First run - no comparison"
            exit 0
          fi
          python3 << 'PYEOF'
          import json
          from datetime import datetime
          with open('data/crypto-data.json') as f: current = json.load(f)
          with open('data/crypto-data-previous.json') as f: previous = json.load(f)
          prev_prices = {c['id']: c['current_price'] for c in previous['data']}
          alerts = []
          for coin in current['data']:
              if coin['id'] not in prev_prices or prev_prices[coin['id']] == 0: continue
              change = ((coin['current_price'] - prev_prices[coin['id']]) / prev_prices[coin['id']]) * 100
              if abs(change) > 5:
                  severity = 'critical' if abs(change) > 20 else 'high' if abs(change) > 10 else 'medium'
                  emoji = 'üî¥' if severity == 'critical' else 'üü†' if severity == 'high' else 'üü°'
                  alerts.append({
                      'crypto_id': coin['id'], 'symbol': coin['symbol'].upper(), 'name': coin['name'],
                      'price_change_percent': round(change, 2), 'previous_price': prev_prices[coin['id']],
                      'current_price': coin['current_price'], 'severity': severity, 'emoji': emoji,
                      'time_interval': '15min',
                      'alert_message': f"{coin['name']} {'surged' if change > 0 else 'dropped'} {abs(round(change,2))}% in 15 minutes"
                  })
          alerts.sort(key=lambda x: ({'critical':0,'high':1,'medium':2}[x['severity']], -abs(x['price_change_percent'])))
          with open('data/whale-alerts.json', 'w') as f:
              json.dump({'timestamp': datetime.utcnow().isoformat()+'Z', 'alerts': alerts, 'total_alerts': len(alerts)}, f, indent=2)
          print(f"Detected {len(alerts)} whale movements")
          PYEOF
      
      - name: Report Generator
        run: |
          echo "Generating dashboard..."
          cp data/crypto-data.json docs/data/
          cp data/whale-alerts.json docs/data/
          # Dashboard HTML generation continues in next command due to size limits
          cat > docs/index.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="refresh" content="900"><title>üåä Crypto Watchtower</title><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);color:#eaeaea;padding:20px}.container{max-width:1400px;margin:0 auto}header{text-align:center;padding:40px 20px;background:rgba(15,52,96,0.3);border-radius:15px;margin-bottom:30px;box-shadow:0 8px 32px rgba(0,0,0,0.3)}header h1{font-size:3em;margin-bottom:10px;background:linear-gradient(45deg,#00d4ff,#0099ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.last-updated{color:#a0a0a0;font-size:0.9em}.whale-alerts{background:rgba(233,69,96,0.1);border-left:4px solid #e94560;padding:20px;border-radius:10px;margin-bottom:30px}.whale-alerts h2{color:#e94560;margin-bottom:15px}.alert-table{width:100%;border-collapse:collapse;margin-top:15px}.alert-table th{background:rgba(15,52,96,0.5);padding:12px;text-align:left}.alert-table td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1)}.severity-critical{background:rgba(220,53,69,0.2)}.severity-high{background:rgba(255,152,0,0.2)}.severity-medium{background:rgba(255,193,7,0.2)}.chart-section{background:rgba(15,52,96,0.2);padding:30px;border-radius:15px;margin-bottom:30px;box-shadow:0 8px 32px rgba(0,0,0,0.2)}.chart-section h2{margin-bottom:20px;color:#00d4ff}.chart-container{position:relative;height:400px}footer{text-align:center;padding:20px;color:#a0a0a0}footer a{color:#00d4ff;text-decoration:none}@media (max-width:768px){header h1{font-size:2em}.chart-container{height:300px}}</style></head><body><div class="container"><header><h1>üåä 24/7 Crypto Watchtower</h1><p class="last-updated">Last Updated: <span id="timestamp">Loading...</span></p></header><div id="whale-alerts-container"></div><div class="chart-section"><h2>üìà Price Overview (Top 20)</h2><div class="chart-container"><canvas id="priceChart"></canvas></div></div><div class="chart-section"><h2>üìä 24h Trading Volume</h2><div class="chart-container"><canvas id="volumeChart"></canvas></div></div><div class="chart-section"><h2>üíé Market Cap (Top 10)</h2><div class="chart-container"><canvas id="marketCapChart"></canvas></div></div><footer><p>Data from CoinGecko API | Updates every 15 minutes | <a href="https://github.com/etlee/stock-website">GitHub</a></p></footer></div><script>async function loadData(){const cryptoData=await fetch('data/crypto-data.json').then(r=>r.json());const whaleAlerts=await fetch('data/whale-alerts.json').then(r=>r.json());document.getElementById('timestamp').textContent=new Date(cryptoData.timestamp).toLocaleString();renderWhaleAlerts(whaleAlerts);renderPriceChart(cryptoData.data);renderVolumeChart(cryptoData.data);renderMarketCapChart(cryptoData.data.slice(0,10))}function renderWhaleAlerts(data){const container=document.getElementById('whale-alerts-container');if(data.total_alerts===0){container.innerHTML='<div class="whale-alerts"><h2>üêã Whale Alerts</h2><p>No significant movements detected.</p></div>';return}let html='<div class="whale-alerts"><h2>üêã Whale Alerts ('+data.total_alerts+')</h2>';html+='<table class="alert-table"><thead><tr><th>Crypto</th><th>Change</th><th>Previous</th><th>Current</th><th>Severity</th></tr></thead><tbody>';data.alerts.forEach(alert=>{const sign=alert.price_change_percent>0?'+':'';html+=`<tr class="severity-${alert.severity}"><td><strong>${alert.name}</strong> (${alert.symbol})</td><td style="font-weight:bold;color:${alert.price_change_percent>0?'#4caf50':'#f44336'}">${sign}${alert.price_change_percent}%</td><td>$${alert.previous_price.toLocaleString()}</td><td>$${alert.current_price.toLocaleString()}</td><td>${alert.emoji} ${alert.severity.toUpperCase()}</td></tr>`});html+='</tbody></table></div>';container.innerHTML=html}function renderPriceChart(data){new Chart(document.getElementById('priceChart').getContext('2d'),{type:'line',data:{labels:data.map(c=>c.name),datasets:[{label:'Price (USD)',data:data.map(c=>c.current_price),borderColor:'#00d4ff',backgroundColor:'rgba(0,212,255,0.1)',tension:0.4,pointBackgroundColor:data.map(c=>c.price_change_percentage_24h>0?'#4caf50':'#f44336')}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#eaeaea'}}},scales:{y:{ticks:{color:'#eaeaea'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#eaeaea',maxRotation:45},grid:{color:'rgba(255,255,255,0.1)'}}}}})}function renderVolumeChart(data){new Chart(document.getElementById('volumeChart').getContext('2d'),{type:'bar',data:{labels:data.map(c=>c.symbol.toUpperCase()),datasets:[{label:'24h Volume',data:data.map(c=>c.total_volume),backgroundColor:'rgba(0,153,255,0.7)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#eaeaea'}}},scales:{y:{ticks:{color:'#eaeaea',callback:v=>'$'+(v/1e9).toFixed(2)+'B'},grid:{color:'rgba(255,255,255,0.1)'}},x:{ticks:{color:'#eaeaea'},grid:{color:'rgba(255,255,255,0.1)'}}}}})}function renderMarketCapChart(data){new Chart(document.getElementById('marketCapChart').getContext('2d'),{type:'bar',data:{labels:data.map(c=>c.name),datasets:[{label:'Market Cap',data:data.map(c=>c.market_cap),backgroundColor:'rgba(156,39,176,0.7)'}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#eaeaea'}}},scales:{x:{ticks:{color:'#eaeaea',callback:v=>'$'+(v/1e9).toFixed(0)+'B'},grid:{color:'rgba(255,255,255,0.1)'}},y:{ticks:{color:'#eaeaea'},grid:{color:'rgba(255,255,255,0.1)'}}}}})}loadData()</script></body></html>
          HTMLEOF
          echo "Dashboard generated"
      
      - name: Deploy
        run: |
          echo "Deploying..."
          git diff --quiet docs/ && echo "No changes" && exit 0
          git add docs/
          git commit -m "Update dashboard - $(date -u +%Y-%m-%dT%H:%M:%SZ)

          - $(jq '.data|length' data/crypto-data.json) coins updated
          - $(jq '.total_alerts' data/whale-alerts.json) whale movements detected"
          git push origin main
          echo "Deployed successfully"
      
      - name: Verify
        run: |
          sleep 30
          curl -sf https://etlee.github.io/stock-website > /dev/null && echo "‚úì Live" || echo "‚ö† Building..."
